// davis.js JavaScript Routing, version: 0.1.1
// (c) 2011 Oliver Nightingale
//
//  Released under MIT license.
//
Davis=function(c){var d=new Davis.App;c.call(d);return d};
Davis.listener=function(){var c=function(b){return function(e){e=new Davis.Request(b.call($(e.target)));Davis.history.pushState(e);return false}},d=c(function(){return{method:"get",fullPath:this.attr("href"),title:this.attr("title")}}),a=c(function(){return{method:this.attr("method"),fullPath:[this.attr("action"),function(b){return b.serializeArray().map(function(e){return[e.name,e.value].join("=")}).join("&")}(this)].join("?"),title:this.attr("title")}});return{listen:function(){$(document).delegate(this.settings.formSelector,
"submit",a);$(document).delegate(this.settings.linkSelector,"click",d)},unlisten:function(){$(document).undelegate(this.settings.linkSelector,"click",d);$(document).undelegate(this.settings.formSelector,"submit",a)}}}();
Davis.event={_callbacks:{},bind:function(c,d){this._callbacks[c]||(this._callbacks[c]=[]);this._callbacks[c].push(d);return this},trigger:function(c){var d=this,a=arguments;this._callbacks[c]||(this._callbacks[c]=[]);this._callbacks[c].forEach(function(b){b.apply(d,Array.prototype.slice.call(a,1))});return this}};
Davis.logger=function(){var c=function(d){d=Array.prototype.slice.call(d);d.unshift("["+Date()+"]");return d};return{error:function(){window.console&&console.error.apply(console,c(arguments))},info:function(){window.console&&console.info.apply(console,c(arguments))},warn:function(){window.console&&console.warn.apply(console,c(arguments))}}}();
Davis.Route=function(){var c=/:([\w\d]+)/g,d=function(a,b,e){this.paramNames=function(){for(var g=[],h;h=c.exec(b);)g.push(h[1]);return g}();var f;f=b instanceof RegExp?b:RegExp("^"+b.replace(c,"([^/]+)")+"$","g");this.path=f;a=a instanceof RegExp?a:RegExp("^"+a+"$");this.method=a;this.callback=e};d.prototype={match:function(a,b){this.reset();return this.method.test(a)&&this.path.test(b)},reset:function(){this.method.lastIndex=0;this.path.lastIndex=0},run:function(a){this.reset();var b=this.path.exec(a.path);
if(b){b.shift();for(var e=0;e<b.length;e++)a.params[this.paramNames[e]]=b[e]}return this.callback.call(a,a)},toString:function(){return[this.method,this.path].join(" ")}};return d}();
Davis.router=function(){var c=this;["get","post","put"].forEach(function(d){c[d]=function(a,b){c._routeCollection.push(new Davis.Route(d,a,b))}});this.del=function(d,a){c._routeCollection.push(new Davis.Route("delete",d,a))};["before","after"].forEach(function(d){c[d]=function(){if(arguments.length==1)var b=/.+/,e=arguments[0];else if(arguments.length==2){b=arguments[0];e=arguments[1]}c._filterCollection[d].push(new Davis.Route(/.+/,b,e))};var a="lookup"+d.replace(/^\w/,function(b){return b.toUpperCase()})+
"Filter";c[a]=function(b,e){return c._filterCollection[d].filter(function(f){return f.match(b,e)})}});c._routeCollection=[];c._filterCollection={before:[],after:[]};c.lookupRoute=function(d,a){return this._routeCollection.filter(function(b){return b.match(d,a)})[0]}};
Davis.history=function(){var c=[],d=function(a){return function(b){if(b.state){b=b.state;b.__proto__=Davis.Request.prototype;a(b)}else a(Davis.Request.forPageLoad())}};return{replaceState:function(a){history.replaceState(a,a.title,a.path);c.forEach(function(b){b(a)})},pushState:function(a){history.pushState(a,a.title,a.path);c.forEach(function(b){b(a)})},onChange:function(a){c.push(a);a=d(a);window.addEventListener("popstate",a,true)}}}();
Davis.Request=function(c){var d=this;this.params={};this.title=c.title;(this.queryString=c.fullPath.split("?")[1])&&this.queryString.split("&").forEach(function(a){var b=a.split("=")[0];a=a.split("=")[1];var e;if(e=/^(\w+)\[(\w+)\]/.exec(b)){var f=e[1];b=e[2];e=d.params[f]||{};e[b]=a;d.params[f]=e}else d.params[b]=a});this.method=this.params._method||c.method;this.path=c.fullPath.replace(/\?.+$/,"")};
Davis.Request.prototype.redirect=function(c){Davis.history.replaceState(new Davis.Request({method:"get",fullPath:c,title:this.title}))};Davis.Request.prototype.toString=function(){return[this.method.toUpperCase(),this.path].join(" ")};Davis.Request.forPageLoad=function(){return new this({method:"get",fullPath:window.location.pathname,title:document.title})};
Davis.App=function(){var c=0,d=function(){this.id=[(new Date).valueOf(),c++].join("-");this.running=false};d.prototype=$.extend({configure:function(a){a.call(this.settings)},settings:{linkSelector:"a",formSelector:"form",logger:Davis.logger},start:function(){var a=this,b=function(f){return function(g){g=g.run(f,f);return typeof g==="undefined"||g}},e=function(f){if(a.lookupBeforeFilter(f.method,f.path).every(b(f))){a.trigger("lookupRoute",f);var g=a.lookupRoute(f.method,f.path);if(g){a.trigger("runRoute",
f,g);g.run(f);a.lookupAfterFilter(f.method,f.path).every(b(f))}else a.trigger("routeNotFound",f)}else a.trigger("requestHalted",f)};Davis.history.onChange(e);this.bind("runRoute",function(f){a.settings.logger.info("runRoute: "+f.toString())}).bind("routeNotFound",function(f){a.settings.logger.warn("routeNotFound: "+f.toString())}).bind("start",function(){a.settings.logger.info("application started")});this.listen();this.trigger("start");this.running=true;e(Davis.Request.forPageLoad())},stop:function(){this.unlisten();
this.trigger("stop")}},Davis.listener,Davis.event);Davis.router.call(d.prototype);return d}();
